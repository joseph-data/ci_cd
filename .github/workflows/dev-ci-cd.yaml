name: DEV CI/CD Pipeline for Events

on:
  push:
    branches:
      - development
      
permissions:
  contents: write
  pull-requests: write 
  
jobs:
  build_dev_environment:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir pandas pytest
          python -m pip list

  run_dev_tests:
    needs: build_dev_environment
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the code again for the test job
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Python environment again
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. Install dependencies again
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir pandas pytest

      # 4. Set PYTHONPATH to include the src directory
      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd)/src" >> $GITHUB_ENV

      # 5. Print Python Path
      - name: Print Python Path
        run: |
          which python
          python --version
          pip --version
          echo $PYTHONPATH

      # 6. Run unit and integration tests using python -m pytest
      - name: Run unit and integration tests
        run: |
          python -m pytest tests/test_events_dev.py

  create_pr_to_staging:
    needs: run_dev_tests
    runs-on: ubuntu-latest
    steps:
      - name: Create or reuse PR (development -> staging)
        id: pr
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = 'development';
            const base = 'staging';

            const comparison = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: `${base}...${head}`,
            });

            if (comparison.data.total_commits === 0) {
              core.info(`No changes to merge from ${head} into ${base}.`);
              return;
            }

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base,
              head: `${owner}:${head}`,
              per_page: 1,
            });

            let pr = prs[0];
            if (!pr) {
              const created = await github.rest.pulls.create({
                owner,
                repo,
                head,
                base,
                title: 'Deploy changes from DEV to staging',
                body: 'This PR automatically deploys all changes from development to staging.',
              });
              pr = created.data;
            }

            core.setOutput('pr_number', String(pr.number));
            core.setOutput('pr_url', pr.html_url);

      - name: Auto-merge PR
        if: steps.pr.outputs.pr_number != ''
        uses: actions/github-script@v6
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = Number(process.env.PR_NUMBER);

            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number,
              merge_method: 'squash',
              commit_title: 'Automatically deploy changes from DEV to staging',
              commit_message: 'Automated merge of development into staging.',
            });
