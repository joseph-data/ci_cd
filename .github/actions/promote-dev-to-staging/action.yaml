name: Promote development to staging
description: Create/reuse PR from a head branch to a base branch and squash-merge it.

inputs:
  head:
    description: Source branch (head)
    required: false
    default: development
  base:
    description: Target branch (base)
    required: false
    default: staging

runs:
  using: composite
  steps:
    - name: Create or reuse PR (head -> base)
      id: pr
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const head = '${{ inputs.head }}';
          const base = '${{ inputs.base }}';

          // Compare commits between base and head to see if there's anything to promote
          const comparison = await github.rest.repos.compareCommitsWithBasehead({
            owner,
            repo,
            basehead: `${base}...${head}`,
          });

          // If there are no commits to merge, exit early
          if (comparison.data.total_commits === 0) {
            core.info(`No changes to merge from ${head} into ${base}.`);
            core.setOutput('pr_number', '');
            core.setOutput('pr_url', '');
            return;
          }

          // Look for an existing open PR from head -> base
          const { data: prs } = await github.rest.pulls.list({
            owner,
            repo,
            state: 'open',
            base,
            head: `${owner}:${head}`,
            per_page: 1,
          });

          let pr = prs[0];

          // If no PR exists, create one
          if (!pr) {
            const created = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title: 'Deploy changes from DEV to staging',
              body: 'This PR automatically deploys all changes from development to staging.',
            });
            pr = created.data;
            core.info(`Created PR #${pr.number}: ${pr.html_url}`);
          } else {
            core.info(`Reusing existing PR #${pr.number}: ${pr.html_url}`);
          }

          // Expose PR details for the next step
          core.setOutput('pr_number', String(pr.number));
          core.setOutput('pr_url', pr.html_url);

    - name: Auto-merge PR
      if: steps.pr.outputs.pr_number != ''
      uses: actions/github-script@v7
      env:
        PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const pull_number = Number(process.env.PR_NUMBER);

          await github.rest.pulls.merge({
            owner,
            repo,
            pull_number,
            merge_method: 'squash',
            commit_title: 'Automatically deploy changes from DEV to staging',
            commit_message: 'Automated merge of development into staging.',
          });

          core.info(`Merged PR #${pull_number} (squash).`);
